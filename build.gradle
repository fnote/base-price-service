plugins {
	id 'org.springframework.boot' version '2.2.4.RELEASE'
	id 'io.spring.dependency-management' version '1.0.9.RELEASE'
	id 'java'
	id 'org.sonarqube' version '2.7'
	id 'jacoco'
}

group = 'com.sysco'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = JavaVersion.VERSION_11
targetCompatibility = JavaVersion.VERSION_11
compileJava.options.encoding = "UTF-8"
compileTestJava.options.encoding = "UTF-8"

repositories {
	mavenCentral()
}

ext.getCurrentBranchName = {
    new ByteArrayOutputStream().withStream { os ->
        exec {
            executable = "git"
            args = ["rev-parse", "--abbrev-ref", "HEAD"]
            standardOutput = os
        }
        return os.toString()
    }
}

ext.getSonarProperties = {
    def props = new Properties()
    file("sonar-project.properties").withInputStream { props.load(it) }
    return props
}

sonarqube {
    def props = getSonarProperties()
    properties {
        props.each { prop ->
            property "${prop.key}", "${prop.value}"
        }
        property "sonar.host.url", "https://infra.labseag-np.us-east-1.aws.sysco.net:9000/"
        property "sonar.login", "d3a6f8fa30b1df9a8c6cf28b199e7363d38aba2d"
		property "sonar.scm.forceReloadAll", "true"
		property 'sonar.core.codeCoveragePlugin', 'jacoco'
        property 'sonar.coverage.jacoco.xmlReportPaths', "${buildDir}/reports/jacoco.xml"
		if (!(getCurrentBranchName().equals("develop") || getCurrentBranchName().equals("master") || project.hasProperty('pullrequest'))) {
			property "sonar.branch.name",getCurrentBranchName()
		}
    }
}

jacocoTestReport {
    reports {
        xml.enabled true
		html.destination file("${buildDir}/reports/coverage")
		xml.destination file("${buildDir}/reports/jacoco.xml")
    }
}

//Do not use compile or complieTest instead use implementation or testImplementation. https://docs.gradle.org/current/userguide/java_plugin.html
dependencies {
	// https://mvnrepository.com/artifact/com.vladmihalcea/hibernate-types-52
	implementation group: 'com.vladmihalcea', name: 'hibernate-types-52', version: '2.9.8'
	// https://mvnrepository.com/artifact/com.fasterxml.jackson.module/jackson-module-jaxb-annotations
	implementation group: 'com.fasterxml.jackson.module', name: 'jackson-module-jaxb-annotations', version: '2.10.3'

	//implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	// https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-aws-autoconfigure
	implementation group: 'org.springframework.cloud', name: 'spring-cloud-aws-autoconfigure', version: '2.1.4.RELEASE'
	implementation group: 'org.springframework.cloud', name: 'spring-cloud-starter-aws-parameter-store-config', version: '2.1.4.RELEASE'
	implementation group: 'org.springframework.boot', name: 'spring-boot-starter-data-jpa', version: '2.2.5.RELEASE'
	// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web
	implementation group: 'org.springframework.boot', name: 'spring-boot-starter-web', version: '2.2.5.RELEASE'
	// https://mvnrepository.com/artifact/mysql/mysql-connector-java
	// https://mvnrepository.com/artifact/mysql/mysql-connector-java
	//implementation group: 'mysql', name: 'mysql-connector-java', version: '8.0.19'
	implementation group: 'org.postgresql', name: 'postgresql', version: '42.2.2'
	// https://mvnrepository.com/artifact/org.liquibase/liquibase-core
	implementation group: 'org.liquibase', name: 'liquibase-core', version: '3.8.7'
	// https://mvnrepository.com/artifact/io.springfox/springfox-swagger2
	implementation (group: 'io.springfox', name: 'springfox-swagger2', version: '2.9.2'){
		exclude module: 'swagger-annotations'
		exclude module: 'swagger-models'
		exclude group: 'com.google.guava',  module: 'guava'
	}
	// https://mvnrepository.com/artifact/com.google.guava/guava/29.0-jre
	implementation group: 'com.google.guava', name: 'guava', version: '29.0-jre'
	// https://mvnrepository.com/artifact/io.swagger/swagger-annotations
	implementation group: 'io.swagger', name: 'swagger-annotations', version: '1.6.1'
	// https://mvnrepository.com/artifact/io.swagger/swagger-models
	implementation group: 'io.swagger', name: 'swagger-models', version: '1.6.1'
    // https://mvnrepository.com/artifact/io.springfox/springfox-swagger-ui
	implementation group: 'io.springfox', name: 'springfox-swagger-ui', version: '2.9.2'
    // https://mvnrepository.com/artifact/io.springfox/springfox-bean-validators
	implementation group: 'io.springfox', name: 'springfox-bean-validators', version: '2.9.2'
    // https://mvnrepository.com/artifact/org.modelmapper/modelmapper
	implementation group: 'org.modelmapper', name: 'modelmapper', version: '2.3.6'
    // https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security
	implementation group: 'org.springframework.boot', name: 'spring-boot-starter-security', version: '2.2.5.RELEASE'
    // https://mvnrepository.com/artifact/com.auth0/auth0-spring-security-api
	implementation group: 'com.auth0', name: 'auth0-spring-security-api', version: '1.3.0'
    // https://mvnrepository.com/artifact/com.auth0/java-jwt
	implementation group: 'com.auth0', name: 'java-jwt', version: '3.10.0'

	implementation group: 'org.drools', name: 'drools-core', version: '7.34.0.Final'

	implementation group: 'org.kie', name: 'kie-ci', version: '7.34.0.Final'

	implementation group: 'org.drools', name: 'drools-compiler', version: '7.34.0.Final'

	implementation group: 'org.drools', name: 'drools-decisiontables', version: '7.34.0.Final'

	implementation group: 'org.kie', name: 'kie-internal', version: '7.34.0.Final'

	implementation group: 'org.kie', name: 'kie-api', version: '7.34.0.Final'

	// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-actuator
	implementation group: 'org.springframework.boot', name: 'spring-boot-starter-actuator', version: '2.2.6.RELEASE'

	testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter', version: '5.4.0'
	// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-test
	testImplementation group: 'org.springframework.boot', name: 'spring-boot-starter-test', version: '2.2.5.RELEASE'
	testImplementation('org.springframework.boot:spring-boot-starter-test') {
		exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
	}

}

test {
	finalizedBy jacocoTestReport
	useJUnitPlatform()
}

project.tasks["sonarqube"].dependsOn "compileJava"
project.tasks["sonarqube"].dependsOn "jacocoTestReport"
